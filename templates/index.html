<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Construction Inspection OBS Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    .obs-number {
      font-size: 3rem;
      font-weight: bold;
      color: #0d6efd;
      text-align: center;
      margin: 20px 0;
    }
    .obs-text {
      font-size: 1.5rem;
      font-weight: bold;
      color: #000000;
      text-align: center;
      margin: 20px 0;
    }
    .btn-primary, .btn-success, .btn-danger, .btn-info, .btn-warning {
      width: 100%;
      margin-top: 10px;
    }
    .status {
      margin-top: 15px;
      text-align: center;
    }
    .pdf-button {
        margin-top: 1vh;
        width: 100%;
    }
    
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Construction Inspection</h1>

  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-3">
        <label for="projectSelect" class="form-label">Select Project:</label>
        <select id="projectSelect" class="form-select" onchange="updateOBSDisplay()"></select>
      </div>

      <div class="obs-text">Next OBS Number:</div>
      <div class="obs-number" id="obsNumber">Loading...</div>

      <a href="#" class="btn btn-success" id="formButton" style="display:none;" target="_blank" onclick="startObservationReport(event)">Start Observation Report</a>
      <!-- <a href="/open_foreman_form" class="btn btn-success" target="_blank">Start Foreman Field Report</a> -->
      <button class="btn btn-secondary pdf-button" onclick="showDateRangePicker()">Generate Reports</button>
      <div id="reportStatus" class="status"></div>
      
      <!-- Download Section (hidden by default) -->
      <div id="downloadSection" style="display:none; margin-top:20px;">
        <div id="downloadMessage" class="alert alert-success" role="alert">
          Reports are ready for download!
        </div>
        <a href="#" id="downloadPdfBtn" class="btn btn-primary" style="display:block !important; width:100% !important; margin-bottom:15px !important;" download>Download PDF Report</a>
        <a href="#" id="downloadCsvBtn" class="btn btn-info" style="display:block !important; width:100% !important; margin-top:15px !important;" download>Download Spreadsheet Report</a>
      </div>
      
      <a href="/edit_obs" class="btn btn-warning">Edit an OBS Report</a>

      <div id="progressContainer" style="display:none;">
        <div style="background:#eee; width:100%; height:24px; border-radius:12px;">
          <div id="progressBar" style="background:#0d6efd; width:0%; height:24px; border-radius:12px; transition:width 0.2s;"></div>
        </div>
        <div id="progressText" style="text-align:center; margin-top:4px;">0%</div>
      </div>
    </div>
  </div>
</div>

<!-- Date Range Picker Modal -->
<div class="modal fade" id="dateRangeModal" tabindex="-1" aria-labelledby="dateRangeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dateRangeModalLabel">Select Date Range</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="startDate" class="form-label">Start Date:</label>
          <input type="date" id="startDate" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="endDate" class="form-label">End Date:</label>
          <input type="date" id="endDate" class="form-control" required>
        </div>
        <div class="text-muted small">
          <p>Quick selects:</p>
          <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(7)">Last 7 days</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(30)">Last 30 days</button>
          <button class="btn btn-sm btn-outline-secondary" onclick="setDateRange(90)">Last 90 days</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmDateRange()">Generate Reports</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  loadProjects();
});

function loadProjects() {
  fetch('/get_projects')
    .then(response => response.json())
    .then(data => {
      const select = document.getElementById('projectSelect');
      select.innerHTML = '';
      
      data.projects.forEach(project => {
        const option = document.createElement('option');
        option.value = project;
        option.textContent = project;
        select.appendChild(option);
      });
      
      // Get last row data to determine default project
      fetch('/get_last_row_data')
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('No last row data');
          }
        })
        .then(lastRowData => {
          // Set default project from last row data
          if (lastRowData && lastRowData.project && data.projects.includes(lastRowData.project)) {
            select.value = lastRowData.project;
          } else if (data.projects.length > 0) {
            select.value = data.projects[0];
          }
          updateOBSDisplay();
        })
        .catch(error => {
          console.log('Using first project as default:', error);
          if (data.projects.length > 0) {
            select.value = data.projects[0];
          }
          updateOBSDisplay();
        });
    });
}

// Modify the updateOBSDisplay function to get last row data
function updateOBSDisplay() {
  const project = document.getElementById('projectSelect').value;
  if (!project) return;
  
  fetch(`/get_current_obs?project=${encodeURIComponent(project)}`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('obsNumber').textContent = data.obs_number;
      document.getElementById('formButton').href = data.form_url;
      document.getElementById('formButton').style.display = 'block';
      
      // Store last row data for use when starting observation
      if (data.last_row_data) {
        window.lastRowData = data.last_row_data;
      }
    });
}

// Update the startObservationReport function to use last row data
function startObservationReport(event) {
  event.preventDefault();
  const project = document.getElementById('projectSelect').value;
  
  fetch(`/get_next_obs?project=${encodeURIComponent(project)}`)
    .then(response => response.json())
    .then(data => {
      // Build URL with last row data if available
      let url = data.form_url;
      if (window.lastRowData) {
        const urlObj = new URL(url);
        // Add the last row data as URL parameters
        // You'll need to match these with your actual form field IDs
        if (window.lastRowData.user) {
          urlObj.searchParams.set('entry.USER_FIELD_ID', window.lastRowData.user);
        }
        if (window.lastRowData.floor) {
          urlObj.searchParams.set('entry.FLOOR_FIELD_ID', window.lastRowData.floor);
        }
        if (window.lastRowData.room) {
          urlObj.searchParams.set('entry.ROOM_FIELD_ID', window.lastRowData.room);
        }
        url = urlObj.toString();
      }
      
      window.open(url, '_blank');
    });
}

let progressInterval;
let progress = 0;
let estimatedTime = 30; // seconds, will be set dynamically
let reportRecordCount = null; // Add this at the top with your other variables

function startFakeProgressBar(recordCount) {
  estimatedTime = Math.max(10, recordCount * 2); // e.g., 2 seconds per record, min 10s
  progress = 0;
  document.getElementById('progressContainer').style.display = '';
  updateProgressBar();
  progressInterval = setInterval(() => {
    if (progress < 99) {
      progress += 100 / (estimatedTime * 2.7778); // update every 500ms
      updateProgressBar();
    }
  }, 500);
}

function updateProgressBar() {
  const bar = document.getElementById('progressBar');
  const text = document.getElementById('progressText');
  bar.style.width = Math.min(progress, 100) + '%';
  text.textContent = Math.floor(Math.min(progress, 100)) + '%';
}

function finishProgressBar() {
  clearInterval(progressInterval);
  progress = 100;
  updateProgressBar();
}

function generateReport() {
  const project = document.getElementById('projectSelect').value;
  document.getElementById('reportStatus').textContent = "Starting report generation...";
  // Get record count first
  fetch(`/get_report_count?project=${encodeURIComponent(project)}`)
    .then(res => res.json())
    .then(data => {
      if (data.count !== undefined) {
        reportRecordCount = data.count; // Store the count for later use
        startFakeProgressBar(data.count);
      }
      // Now start the report generation
      return fetch('/generate_report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project})
      });
    })
    .then(res => res.json())
    .then(data => {
      if (data.job_id) {
        pollReportStatus(data.job_id);
      } else {
        document.getElementById('reportStatus').textContent = "Failed to start report.";
        document.getElementById('progressContainer').style.display = 'none';
      }
    });
}

function pollReportStatus(job_id) {
  fetch(`/report_status/${job_id}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "finished") {
        finishProgressBar();
        document.getElementById('reportStatus').innerHTML =
          `<a href="${data.download_url}">Download PDF Report</a>`;
      } else if (data.status === "failed") {
        document.getElementById('reportStatus').textContent = "Report generation failed.";
        document.getElementById('progressContainer').style.display = 'none';
      } else {
        // Show the record count in the status message
        let msg = "";
        if (reportRecordCount !== null) {
          msg = `${reportRecordCount} records found. `;
        }
        document.getElementById('reportStatus').textContent = msg + "Report is processing...";
        setTimeout(() => pollReportStatus(job_id), 2000);
      }
    });
}

// New functions for date range picker
let dateRangeModal;

function showDateRangePicker() {
  if (!dateRangeModal) {
    dateRangeModal = new bootstrap.Modal(document.getElementById('dateRangeModal'));
  }
  
  // Set default dates - today for end, 7 days ago for start
  const today = new Date();
  const sevenDaysAgo = new Date(today);
  sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
  
  document.getElementById('endDate').value = today.toISOString().split('T')[0];
  document.getElementById('startDate').value = sevenDaysAgo.toISOString().split('T')[0];
  document.getElementById('endDate').max = today.toISOString().split('T')[0];
  document.getElementById('startDate').max = today.toISOString().split('T')[0];
  
  dateRangeModal.show();
}

function setDateRange(days) {
  const endDate = new Date();
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - days);
  
  document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
  document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
}

function confirmDateRange() {
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const project = document.getElementById('projectSelect').value;
  
  if (!startDate || !endDate) {
    alert('Please select both start and end dates');
    return;
  }
  
  if (new Date(startDate) > new Date(endDate)) {
    alert('Start date must be before end date');
    return;
  }
  
  // Hide modal
  dateRangeModal.hide();
  
  // Hide download section and reset status
  document.getElementById('downloadSection').style.display = 'none';
  document.getElementById('reportStatus').textContent = "Generating reports...";
  document.getElementById('progressContainer').style.display = '';
  startFakeProgressBar(10); // Default estimate
  
  // Send request to generate both reports
  fetch('/generate_reports', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      project: project,
      start_date: startDate,
      end_date: endDate
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.job_id) {
      pollReportsStatus(data.job_id);
    } else {
      document.getElementById('reportStatus').textContent = "Failed to start report generation.";
      document.getElementById('progressContainer').style.display = 'none';
    }
  })
  .catch(err => {
    document.getElementById('reportStatus').textContent = "Error: " + err.message;
    document.getElementById('progressContainer').style.display = 'none';
  });
}

function pollReportsStatus(job_id) {
  fetch(`/reports_status/${job_id}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "finished") {
        finishProgressBar();
        document.getElementById('reportStatus').textContent = "";
        document.getElementById('progressContainer').style.display = 'none';
        
        // Show download section
        document.getElementById('downloadSection').style.display = 'block';
        document.getElementById('downloadMessage').textContent = "Reports are ready for download!";
        document.getElementById('downloadPdfBtn').href = data.pdf_url;
        document.getElementById('downloadCsvBtn').href = data.csv_url;
        document.getElementById('downloadPdfBtn').style.display = 'block';
      } else if (data.status === "failed") {
        document.getElementById('reportStatus').textContent = "Report generation failed: " + (data.error || "Unknown error");
        document.getElementById('progressContainer').style.display = 'none';
        if (data.csv_url) {
          document.getElementById('downloadSection').style.display = 'block';
          document.getElementById('downloadMessage').textContent = "PDF failed, but the spreadsheet is ready to download.";
          document.getElementById('downloadPdfBtn').style.display = 'none';
          document.getElementById('downloadCsvBtn').href = data.csv_url;
        }
      } else if (data.status === "in_progress") {
        // Use real progress if available
        if (data.progress !== undefined) {
          clearInterval(progressInterval); // Stop fake progress
          progress = data.progress;
          updateProgressBar();
          
          // Show different message based on phase
          if (data.phase === 'merging_pdfs') {
            document.getElementById('reportStatus').textContent = `Merging PDFs into final report... (${data.processed}/${data.total} processed)`;
          } else {
            document.getElementById('reportStatus').textContent = `Processing reports... (${data.processed || 0}/${data.total || 0})`;
          }
        } else {
          document.getElementById('reportStatus').textContent = "Processing reports...";
        }
        if (data.csv_url) {
          document.getElementById('downloadSection').style.display = 'block';
          document.getElementById('downloadMessage').textContent = "Spreadsheet is ready. PDF is still processing.";
          document.getElementById('downloadPdfBtn').style.display = 'none';
          document.getElementById('downloadCsvBtn').href = data.csv_url;
        }
        setTimeout(() => pollReportsStatus(job_id), 1000); // Poll every second for smoother updates
      } else {
        document.getElementById('reportStatus').textContent = "Processing reports...";
        setTimeout(() => pollReportsStatus(job_id), 2000);
      }
    })
    .catch(err => {
      document.getElementById('reportStatus').textContent = "Error checking status: " + err.message;
    });
}

</script>
</body>
</html>


