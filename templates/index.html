<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Construction Inspection OBS Generator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      background-color: #f8f9fa;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    .obs-number {
      font-size: 3rem;
      font-weight: bold;
      color: #0d6efd;
      text-align: center;
      margin: 20px 0;
    }
    .obs-text {
      font-size: 1.5rem;
      font-weight: bold;
      color: #000000;
      text-align: center;
      margin: 20px 0;
    }
    .btn-primary, .btn-success, .btn-danger {
      width: 100%;
      margin-top: 10px;
    }
    .status {
      margin-top: 15px;
      text-align: center;
    }
    .pdf-button {
        margin-top: 1vh;
        width: 100%;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="text-center mb-4">Construction Inspection</h1>

  <div class="card mb-4">
    <div class="card-body">
      <div class="mb-3">
        <label for="projectSelect" class="form-label">Select Project:</label>
        <select id="projectSelect" class="form-select" onchange="updateOBSDisplay()"></select>
      </div>

      <div class="obs-text">Next OBS Number:</div>
      <div class="obs-number" id="obsNumber">Loading...</div>

      <a href="#" class="btn btn-success" id="formButton" style="display:none;" target="_blank" onclick="startObservationReport(event)">Start Observation Report</a>
      <!-- <a href="/open_foreman_form" class="btn btn-success" target="_blank">Start Foreman Field Report</a> -->
      <button class="btn btn-secondary pdf-button" onclick="generateReport()">Generate PDF Report</button>
      <div id="reportStatus" class="status"></div>

      <div id="progressContainer" style="display:none;">
        <div style="background:#eee; width:100%; height:24px; border-radius:12px;">
          <div id="progressBar" style="background:#0d6efd; width:0%; height:24px; border-radius:12px; transition:width 0.2s;"></div>
        </div>
        <div id="progressText" style="text-align:center; margin-top:4px;">0%</div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  loadProjects();
});

function loadProjects() {
  fetch('/get_projects')
    .then(res => res.json())
    .then(data => {
      const select = document.getElementById('projectSelect');
      select.innerHTML = '';
      data.projects.forEach(project => {
        const opt = document.createElement('option');
        opt.value = project;
        opt.textContent = project;
        select.appendChild(opt);
      });
      updateOBSDisplay();
    })
    .catch(err => console.error('Error loading projects:', err));
}

function updateOBSDisplay() {
  const project = document.getElementById('projectSelect').value;
  fetch(`/get_current_obs?project=${encodeURIComponent(project)}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('obsNumber').textContent = data.obs_number;
      const formBtn = document.getElementById('formButton');
      formBtn.href = `/open_observation_form?project=${encodeURIComponent(project)}`;
      formBtn.style.display = 'inline-block';
    })
    .catch(err => console.error('Error updating OBS display:', err));
}

function startObservationReport(event) {
  event.preventDefault();
  const project = document.getElementById('projectSelect').value;
  // Get the current OBS number and form URL
  fetch(`/get_current_obs?project=${encodeURIComponent(project)}`)
    .then(res => res.json())
    .then(data => {
      // Open the form with the current OBS number
      if (data.form_url) {
        window.open(data.form_url, '_blank');
      }
      // Now increment the OBS number for next time
      fetch(`/get_next_obs?project=${encodeURIComponent(project)}`)
        .then(res => res.json())
        .then(nextData => {
          // Update the displayed OBS number
          document.getElementById('obsNumber').textContent = nextData.obs_number;
        });
    })
    .catch(err => {
      console.error('Error starting observation report:', err);
    });
}

let progressInterval;
let progress = 0;
let estimatedTime = 30; // seconds, will be set dynamically

function startFakeProgressBar(recordCount) {
  estimatedTime = Math.max(10, recordCount * 2); // e.g., 2 seconds per record, min 10s
  progress = 0;
  document.getElementById('progressContainer').style.display = '';
  updateProgressBar();
  progressInterval = setInterval(() => {
    if (progress < 99) {
      progress += 100 / (estimatedTime * 2); // update every 500ms
      updateProgressBar();
    }
  }, 500);
}

function updateProgressBar() {
  const bar = document.getElementById('progressBar');
  const text = document.getElementById('progressText');
  bar.style.width = Math.min(progress, 100) + '%';
  text.textContent = Math.floor(Math.min(progress, 100)) + '%';
}

function finishProgressBar() {
  clearInterval(progressInterval);
  progress = 100;
  updateProgressBar();
}

function generateReport() {
  const project = document.getElementById('projectSelect').value;
  document.getElementById('reportStatus').textContent = "Starting report generation...";
  // Get record count first
  fetch(`/get_report_count?project=${encodeURIComponent(project)}`)
    .then(res => res.json())
    .then(data => {
      if (data.count !== undefined) {
        startFakeProgressBar(data.count);
      }
      // Now start the report generation
      return fetch('/generate_report', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({project})
      });
    })
    .then(res => res.json())
    .then(data => {
      if (data.job_id) {
        pollReportStatus(data.job_id);
      } else {
        document.getElementById('reportStatus').textContent = "Failed to start report.";
        document.getElementById('progressContainer').style.display = 'none';
      }
    });
}

function pollReportStatus(job_id) {
  fetch(`/report_status/${job_id}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "finished") {
        finishProgressBar();
        document.getElementById('reportStatus').innerHTML =
          `<a href="${data.download_url}">Download PDF Report</a>`;
      } else if (data.status === "failed") {
        document.getElementById('reportStatus').textContent = "Report generation failed.";
        document.getElementById('progressContainer').style.display = 'none';
      } else {
        document.getElementById('reportStatus').textContent = "Report is processing...";
        setTimeout(() => pollReportStatus(job_id), 2000);
      }
    });
}
</script>
</body>
</html>


